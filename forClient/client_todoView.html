<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script type="text/javascript" src="https://unpkg.com/vue@next"></script>
  <style>
    th, td {
      text-align: center; /* 文本置中 */
    }
  </style>
</head>
  
<body>
  <hr />
  <!-- 商品瀏覽介面 -->
  <div id="main">
    <div id="list" v-if="UI=='main'">
      <h1>商品瀏覽介面</h1>
      <p>使用者您好，custID = {{ custID }}</p>
      <button @click="setUI('checkCart')">查看購物車</button>
      <button @click="setUI('orderView')">查看訂單</button>
      <table border=1>
        <tr><td>序號</td><td>商品名稱</td><td>商品說明</td><td>商品價格</td><td>商品數量</td><td>-</td></tr>
        <!-- array : dat -->
        <tr v-for="product in dat"> 
          <td>{{product.id}}</td>
          <td>{{product.name}}</td>
          <td>{{product.illustrate}}</td>
          <td>{{product.price}}</td>
          <td>
            <!-- quantity是決定要放入購物車某商品的數量 -->
            <input v-model="product.quantity" type="number" :id="'quantity' + product.id" name="quantity" min="0" max="99">
          </td>
          <!-- 加入購物車 confirmAddToCart跳出window確定選取 -->
          <td><button @click="confirmAddToCart(product.id, product.quantity)">加入購物車</button></td>
        </tr>
      </table>
    </div>

    <!-- 購物車瀏覽介面 -->
    <div v-if="UI=='checkCart'">
      <h1>購物車介面</h1>
      <table border=1>
        <tr><td>序號</td><td>商品名稱</td><td>商品價格</td><td>商品數量</td><td>-</td></tr>
        <!-- array : cart -->
        <tr v-for="item in cart"> 
          <td>{{item.id}}</td>
          <td>{{item.name}}</td>
          <td>{{item.price}}</td>
          <td>{{item.quantity}}</td>
          <!-- 從購物車移除某商品 confirmDelToCart跳出window確定移除 -->
          <td><button @click="confirmDelToCart(item.id)">移除</button></td>
        </tr>
        <!-- 新增顯示總價的列 -->
        <tr>
          <td colspan="3"></td>
          <td><strong>總價</strong></td>
          <td>{{ calculateTotalPrice() }}</td>
        </tr>
        <tr>
          <td colspan="5">
            <button @click="confirmCheckout()">送出訂單</button>
          </td>
        </tr>
      </table>
      <!-- 返回商品瀏覽介面 -->
      <button @click="setUI('main')">返回商品介面</button>
    </div>

    <!-- 訂單瀏覽介面 -->
<div v-if="UI=='orderView'">
  <h1>訂單瀏覽介面</h1>
  <table border=1>
    <tr><td>訂單編號</td><td>客戶編號</td><td>金額</td><td>狀態</td><td>評價</td></tr>
    <!-- array : orders -->
    <tr v-for="order in orders"> 
      <td>{{order.id}}</td>
      <td>{{order.custID}}</td>
      <td>{{order.price}}</td>
      <td>{{order.status}}</td>
      <td>
        <!-- 使用條件判斷式，如果評價為0，顯示「未評價」 -->
        <span v-if="order.evaluate === 0">未評價</span>
        <span v-else>{{order.evaluate}}</span>
      </td>
    </tr>
    <tr>
      <td colspan="5">
        <button @click="setUI('main')">返回商品介面</button>
      </td>
    </tr>
  </table>
</div>

  <script>
    const todoApp = Vue.createApp({
      data() {
        return {
          UI: 'main',
          dat: [],
          cart: [],
          orders: [],
          custID: 1,
        }
      },
      methods: {
        loadList: function () {
          const that = this; 
          fetch('client_todoControl.php?act=listProduct')
            .then(function(response) {
              return response.json();
            })
            .then(function(myJson) {
              that.dat = myJson;
            });
        },
        checkCart: function () {
          const that = this; 
          fetch('client_todoControl.php?act=checkProduct')
            .then(function(response) {
              return response.json();
            })
            .then(function(myJson) {
              console.log(myJson);
              that.cart = myJson;
            });
        },
        checkOrder: function () {
          const that = this; 
          fetch('client_todoControl.php?act=listOrder')
            .then(function(response) {
              return response.json();
            })
            .then(function(myJson) {
              console.log(myJson);
              that.orders = myJson;
            });
        },
        checkList: function () {
          const that = this;
          fetch('client_todoControl.php?act=checkoutCart', {
            method: 'POST',
          })
          .then(function(response) {
            return response.json();
          })
          .then(function(myJson) {
            console.log(myJson);
            if (myJson.success) {
              that.cart = [];
              that.setUI('main');

              // 更新訂單資料
              that.checkOrder();
            } else {
              console.error('結帳失敗:', myJson.message);
            }
          });
        },
        calculateTotalPrice() {
          return this.cart.reduce((total, item) => total + item.price * item.quantity, 0);
        },
        delCart: function (id) {
          const that = this;
          let url = "client_todoControl.php?act=delCart&id=" + id;
          fetch(url, {
            method: 'POST'
          })
          .then(function(res){return res.text(); })
          .then(function(data){
            console.log(data);
            that.loadList(); 
            that.checkCart();
          });
        },
        confirmAddToCart(id, quantity) {
          const isConfirmed = window.confirm('確定要將商品加入購物車嗎？');
          if (isConfirmed) {
            this.addCart(id, quantity);
          }
        },
        confirmDelToCart(id) {
          const isConfirmed = window.confirm('確定要將商品從購物車刪除嗎？');
          if (isConfirmed) {
            this.delCart(id);
          }
        },
        confirmCheckout() {
          const isConfirmed = window.confirm('確定要送出訂單嗎？');
          if (isConfirmed) {
            this.checkList(); 
          }
        },
        addCart: function (id, quantity) {
          const that = this;
          const requestData = {
            id: id,
            quantity: quantity,
          };
          fetch('client_todoControl.php?act=addCart&id='+id+'&quantity='+quantity, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
          })
          .then(function(res) {
            return res.text();
          })
          .then(function(data) {
            console.log(data);
            that.setUI('main');
            that.loadList();
            that.checkCart();
          });
        },
        setUI: function(page) {
          this.UI = page;
        },
      },
      created() {
        this.loadList();
        this.checkCart();
        this.checkOrder();
      }
    }).mount("#main");
  </script>
</body>
</html>
