<html><head>
  <!-- 109213069 梁心瑜 109213041 林國棟 -->
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script type="text/javascript" src="https://unpkg.com/vue@next"></script>
  <style>
    th, td {
      text-align: center; /* 文本置中 */
    }
  </style>
  </head>
  
  <body >
  <hr />
  <!-- 商品瀏覽介面 -->
  <div id="main">
  <div id="list" v-if="UI=='main'">
    <a href="initial.html">載入初始頁面</a>
    <h1>Product Viewing Interface</h1>
    <button @click="setUI('checkCart')">查看購物車</button>
    <table border=1>
      <tr><td>序號</td><td>商品名稱</td><td>商品說明</td><td>商品價格</td><td>商品數量</td><td>-</td></tr>
      <!-- array : dat -->
      <tr v-for="product in dat"> 
        <td>{{product.id}}</td>
        <td>{{product.name}}</td>
        <td>{{product.illustrate}}</td>
        <td>{{product.price}}</td>
        <td>
        <!-- quantity是決定要放入購物車某商品的數量 -->
        <input v-model="product.quantity" type="number" :id="'quantity' + product.id" name="quantity" min="0" max="99"></td>
        <!-- 加入購物車 confirmAddToCart跳出window確定選取 -->
        <td><button @click="confirmAddToCart(product.id, product.quantity)">加入購物車</button></td>
      </tr>
    </table>
  </div>
  <!-- 購物車瀏覽介面 -->
  <div v-if="UI=='checkCart'">
    <h1>Shopping Cart Interface</h1>
    <table border=1>
      <tr><td>序號</td><td>商品名稱</td><td>商品價格</td><td>商品數量</td><td>-</td></tr>
      <!-- array : cart -->
      <tr v-for="item in cart"> 
        <td>{{item.id}}</td>
        <td>{{item.name}}</td>
        <td>{{item.price}}</td>
        <td>{{item.quantity}}</td>
        <!-- 從購物車移除某商品 confirmDelToCart跳出window確定移除 -->
        <td><button @click="confirmDelToCart(item.id)">移除</button></td>
      </tr>
      <!-- 新增顯示總價的列 -->
      <tr>
        <td colspan="3"></td>
        <td><strong>總價</strong></td>
        <td>{{ calculateTotalPrice() }}</td>
      </tr>
    </table>
    <!-- 返回商品瀏覽介面 -->
    <button @click="setUI('main')">返回商品介面</button>
  </div>
  </div>
  <script>
  const todoApp= Vue.createApp({ //宣告 利用物件裡的createApp
    data() { //在app裡定義資料結構為data
      return { //回傳以下物件
        UI: 'main',
        dat: [], //商品瀏覽介面的內容
        cart: [], //購物車介面的內容
      }
    },
    methods: {
      loadList: function () { //商品瀏覽介面清單
        const that=this; 
        fetch('client_todoControl.php?act=listProduct') // --> 至todoControl的listProsuct
        .then(function(response) {
          return response.json();
        })
        .then(function(myJson) {
          that.dat = myJson;
        });
      },
      checkCart: function () { //購物車瀏覽介面清單
        const that=this; 
        fetch('client_todoControl.php?act=checkProduct') // --> 至todoControl的checkProduct
        .then(function(response) {
          return response.json();
        })
        .then(function(myJson) {
          console.log(myJson);
          that.cart = myJson;
        });
      },
      calculateTotalPrice() { //計算總價
      let totalPrice = 0;
      for (let i = 0; i < this.cart.length; i++) {
        totalPrice += this.cart[i].price * this.cart[i].quantity;
      }
      return totalPrice; 
      },
      delCart: function (id) { //刪除購物車內某商品
        const that=this;
        let url="client_todoControl.php?act=delCart&id="+id; //--> 至todoControl的delCart
        fetch(url,{
          method: 'POST'
        })
        .then(function(res){return res.text(); }) //取得傳回值，轉為文字
        .then(function(data){
          console.log(data);
          that.loadList(); 
          that.checkCart(); // refresh the cart immediately
        })
      },
      confirmAddToCart(id, quantity) {
      // 使用 confirm 函數彈出確認對話框
      const isConfirmed = window.confirm('確定要將商品加入購物車嗎？');

      // 如果用戶按下確認，執行加入購物車的相應邏輯
      if (isConfirmed) {
        const quantity = document.getElementById('quantity'+id).value;
        this.addCart(id, quantity); // --> addCart()
      }
    },
    confirmDelToCart(id) {
      // 使用 confirm 函數彈出確認對話框
      const isConfirmed = window.confirm('確定要將商品從購物車刪除嗎？');

      // 如果用戶按下確認，執行移除商品的相應邏輯
      if (isConfirmed) {
        this.delCart(id); // --> delCart()
      }
    },
      addCart: function (id, quantity) { //新增某商品至購物車
        const that=this;
        const requestData = {
          id: id,
          quantity: quantity,
        };
        fetch('client_todoControl.php?act=addCart&id='+id+'&quantity='+quantity, { //--> 至todoControl的addCart
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData),
        })
        .then(function(res) {
          return res.text();
        })
        .then(function(data) {
          console.log(data);
          that.setUI('main');
          that.loadList();
          that.checkCart(); // refresh the cart immediately
        });
      },
      setUI: function(page) { //把vue裡面的變數設成自己指定的值
        this.UI=page;
      }
    },
    created() {
      this.loadList();
      this.checkCart();
    }
  }).mount("#main");
  
  </script>
  </body></html>